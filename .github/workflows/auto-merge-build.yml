name: Auto Merge and Build

on:
  schedule:
    - cron: '0 0 */10 * *'  # Every 10 days
  workflow_dispatch:  # Manual trigger option

jobs:
  merge-and-build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout your fork
      uses: actions/checkout@v3
      with:
        fetch-depth: 0
        token: ${{ secrets.GITHUB_TOKEN }}
        
    - name: Setup upstream
      run: |
        git remote add upstream https://github.com/mollyim/mollyim-android.git
        git fetch upstream
        
    - name: Get upstream version
      id: version
      run: |
        UPSTREAM_VERSION=$(git describe --tags upstream/main --abbrev=0 2>/dev/null || echo "unknown")
        echo "upstream_version=$UPSTREAM_VERSION" >> $GITHUB_OUTPUT
        DATE=$(date +%Y.%m.%d)
        echo "build_date=$DATE" >> $GITHUB_OUTPUT
        
    - name: Merge upstream changes
      id: merge
      run: |
        git config user.name "GitHub Actions"
        git config user.email "actions@github.com"
        git checkout disable-gif-linkpreview
        
        # Attempt merge and capture result
        if git merge upstream/main --no-edit; then
          echo "merge_success=true" >> $GITHUB_OUTPUT
          git push origin disable-gif-linkpreview
        else
          echo "merge_success=false" >> $GITHUB_OUTPUT
          echo "Merge conflicts detected. Manual intervention required."
          exit 1
        fi
        
    - name: Set up JDK
      if: steps.merge.outputs.merge_success == 'true'
      uses: actions/setup-java@v3
      with:
        java-version: '17'
        distribution: 'temurin'
        
    - name: Setup Android SDK
      if: steps.merge.outputs.merge_success == 'true'
      uses: android-actions/setup-android@v2
      with:
        api-level: 35
        build-tools: 35.0.0
        ndk: 28.0.13004108
        
    - name: Build APK
      if: steps.merge.outputs.merge_success == 'true'
      run: |
        chmod +x gradlew
        ./gradlew assembleProdFossWebsiteRelease
        
    - name: Get APK info
      if: steps.merge.outputs.merge_success == 'true'
      id: apk_info
      run: |
        APK_PATH=$(find app/build/outputs/apk -name "*.apk" | head -1)
        APK_SIZE=$(ls -lh "$APK_PATH" | awk '{print $5}')
        echo "apk_path=$APK_PATH" >> $GITHUB_OUTPUT
        echo "apk_size=$APK_SIZE" >> $GITHUB_OUTPUT
        echo "apk_name=$(basename $APK_PATH)" >> $GITHUB_OUTPUT
        
    - name: Create Release
      if: steps.merge.outputs.merge_success == 'true'
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ steps.version.outputs.upstream_version }}-privacy-${{ steps.version.outputs.build_date }}
        name: "Molly Privacy Enhanced ${{ steps.version.outputs.upstream_version }} (${{ steps.version.outputs.build_date }})"
        body: |
          ## ğŸ”’ Molly Privacy Enhanced - Automated Build (Every 10 Days)
          
          **Base Version**: ${{ steps.version.outputs.upstream_version }}  
          **Build Date**: ${{ steps.version.outputs.build_date }}  
          **APK Size**: ${{ steps.apk_info.outputs.apk_size }}
          
          ### ğŸ›¡ï¸ Privacy Modifications Included:
          - âŒ **GIF Search Disabled**: No external Giphy API calls
          - âŒ **Link Previews Disabled**: No automatic webpage fetching  
          - âœ… **All Molly Features**: Complete messaging, calling, encryption
          
          ### ğŸ“± Installation:
          ```bash
          adb install ${{ steps.apk_info.outputs.apk_name }}
          ```
          
          ### ğŸ§ª Testing:
          - **GIF Test**: Should show "GIF search disabled" toast
          - **Link Test**: URLs appear as plain text (no previews)
          
          ### ğŸ”„ Auto-Generated:
          This release was automatically generated from upstream Molly changes.
          Privacy modifications remain intact and functional.
          
          ---
          **ğŸ”’ Privacy First** â€¢ **ğŸ“± Fully Functional** â€¢ **ğŸ¤– Auto-Updated**
        files: |
          ${{ steps.apk_info.outputs.apk_path }}
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        
    - name: Upload Backup Artifact
      if: steps.merge.outputs.merge_success == 'true'
      uses: actions/upload-artifact@v3
      with:
        name: molly-privacy-${{ steps.version.outputs.build_date }}
        path: ${{ steps.apk_info.outputs.apk_path }}
        retention-days: 90